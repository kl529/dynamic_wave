'use client'

import { DongpaConfig, MarketData, DongpaTrade, TodaySignal } from '@/types';
import { getWeeklyRSIModeInfo, enrichDataWithWeeklyRSIMode, WeeklyModeInfo } from '@/utils/rsiCalculator';
import { getModeConfig, getTotalFeeRate, calculateTradingDays } from '@/utils/tradingConfig';

export class DongpaEngine {
  private config: DongpaConfig;
  private autoMode: boolean;  // RSI ê¸°ë°˜ ìë™ ëª¨ë“œ ì „í™˜

  constructor(config: DongpaConfig, autoMode: boolean = true) {
    this.config = config;
    this.autoMode = autoMode;  // ê¸°ë³¸ê°’: RSI ìë™ ëª¨ë“œ í™œì„±í™”
  }

  /**
   * ìë™ ëª¨ë“œ ì„¤ì • ë³€ê²½
   */
  public setAutoMode(enabled: boolean): void {
    this.autoMode = enabled;
  }

  /**
   * í˜„ì¬ RSI ê¸°ë°˜ ëª¨ë“œ ì •ë³´ ë°˜í™˜
   */
  public getRSIModeInfo(priceData: MarketData[]): WeeklyModeInfo {
    return getWeeklyRSIModeInfo(priceData);
  }

  /**
   * ë§¤ìˆ˜ ì¡°ê±´ í™•ì¸
   * - ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ì˜¤ëŠ˜ ì¢…ê°€ì˜ ë³€ë™ë¥ ì´ ëª©í‘œ ìƒìŠ¹ë¥  ë¯¸ë§Œì¸ì§€ ì²´í¬
   * - ì²´ê²°ê°€ëŠ” ì˜¤ëŠ˜ ì¢…ê°€
   */
  public getTodayBuySignal(config: {
    ì´ˆê¸°ìê¸ˆ: number;
    ë¶„í• íšŸìˆ˜: number;
    ë§¤ë§¤ëª¨ë“œ: 'safe' | 'aggressive';
    ì˜¤ëŠ˜ì¢…ê°€: number;
    ì „ì¼ì¢…ê°€: number;
    ì˜ˆìˆ˜ê¸ˆ: number;
  }): {
    ì‹ í˜¸: 'BUY' | 'HOLD';
    ë§¤ìˆ˜ëŸ‰: number;
    ë§¤ìˆ˜ê°€: number;  // LOC ì²´ê²°ê°€ (ì˜¤ëŠ˜ ì¢…ê°€)
    ë§¤ìˆ˜ê¸ˆì•¡: number;
    ìˆ˜ìˆ˜ë£Œ: number;
    ìƒìŠ¹ë¥ : number;
    ëª©í‘œìƒìŠ¹ë¥ : number;
    ë©”ì‹œì§€: string;
  } {
    const { ì´ˆê¸°ìê¸ˆ, ë¶„í• íšŸìˆ˜, ë§¤ë§¤ëª¨ë“œ, ì˜¤ëŠ˜ì¢…ê°€, ì „ì¼ì¢…ê°€, ì˜ˆìˆ˜ê¸ˆ } = config;
    const modeConfig = getModeConfig(ë§¤ë§¤ëª¨ë“œ);

    // ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ì˜¤ëŠ˜ ì¢…ê°€ ë³€ë™ë¥  ê³„ì‚°
    const ë³€ë™ë¥  = ((ì˜¤ëŠ˜ì¢…ê°€ - ì „ì¼ì¢…ê°€) / ì „ì¼ì¢…ê°€);
    const ëª©í‘œìƒìŠ¹ë¥  = modeConfig.buyTarget;

    // ë¶„í• ê¸ˆì•¡ ê³„ì‚°
    const ë¶„í• ê¸ˆì•¡ = ì´ˆê¸°ìê¸ˆ / ë¶„í• íšŸìˆ˜;

    // ë§¤ìˆ˜ ì¡°ê±´: ë³€ë™ë¥  < ëª©í‘œìƒìŠ¹ë¥  (ëª©í‘œë³´ë‹¤ ë‚®ìœ¼ë©´ ë§¤ìˆ˜)
    if (ë³€ë™ë¥  < ëª©í‘œìƒìŠ¹ë¥  && ì˜ˆìˆ˜ê¸ˆ >= ë¶„í• ê¸ˆì•¡) {
      // LOC: ì˜¤ëŠ˜ ì¢…ê°€ì— ë§¤ìˆ˜
      const ë§¤ìˆ˜ëŸ‰ = Math.floor(ë¶„í• ê¸ˆì•¡ / ì˜¤ëŠ˜ì¢…ê°€);
      const ë§¤ìˆ˜ê¸ˆì•¡ = ë§¤ìˆ˜ëŸ‰ * ì˜¤ëŠ˜ì¢…ê°€;
      const ìˆ˜ìˆ˜ë£Œ = ë§¤ìˆ˜ê¸ˆì•¡ * getTotalFeeRate();

      if (ì˜ˆìˆ˜ê¸ˆ >= ë§¤ìˆ˜ê¸ˆì•¡ + ìˆ˜ìˆ˜ë£Œ) {
        return {
          ì‹ í˜¸: 'BUY',
          ë§¤ìˆ˜ëŸ‰,
          ë§¤ìˆ˜ê°€: ì˜¤ëŠ˜ì¢…ê°€,
          ë§¤ìˆ˜ê¸ˆì•¡,
          ìˆ˜ìˆ˜ë£Œ,
          ìƒìŠ¹ë¥ : ë³€ë™ë¥  * 100,  // ì‹¤ì œë¡œëŠ” ë³€ë™ë¥ 
          ëª©í‘œìƒìŠ¹ë¥ : ëª©í‘œìƒìŠ¹ë¥  * 100,
          ë©”ì‹œì§€: `ğŸ”» ë§¤ìˆ˜: ${ë§¤ìˆ˜ëŸ‰}ì£¼ @$${ì˜¤ëŠ˜ì¢…ê°€.toFixed(2)} (ë³€ë™ë¥  ${(ë³€ë™ë¥  * 100).toFixed(2)}% < ëª©í‘œ ${(ëª©í‘œìƒìŠ¹ë¥  * 100).toFixed(2)}%)`
        };
      }
    }

    return {
      ì‹ í˜¸: 'HOLD',
      ë§¤ìˆ˜ëŸ‰: 0,
      ë§¤ìˆ˜ê°€: 0,
      ë§¤ìˆ˜ê¸ˆì•¡: 0,
      ìˆ˜ìˆ˜ë£Œ: 0,
      ìƒìŠ¹ë¥ : ë³€ë™ë¥  * 100,
      ëª©í‘œìƒìŠ¹ë¥ : ëª©í‘œìƒìŠ¹ë¥  * 100,
      ë©”ì‹œì§€: ë³€ë™ë¥  >= ëª©í‘œìƒìŠ¹ë¥ 
        ? `ëŒ€ê¸°: ë³€ë™ë¥  ${(ë³€ë™ë¥  * 100).toFixed(2)}% >= ëª©í‘œ ${(ëª©í‘œìƒìŠ¹ë¥  * 100).toFixed(2)}%`
        : `í˜„ê¸ˆ ë¶€ì¡± (í•„ìš”: $${ë¶„í• ê¸ˆì•¡.toFixed(2)}, ë³´ìœ : $${ì˜ˆìˆ˜ê¸ˆ.toFixed(2)})`
    };
  }

  /**
   * ë§¤ë„ ì¡°ê±´ í™•ì¸ (ì¢…ê°€ë§¤ë§¤ LOC ë°©ì‹)
   * - í‰ë‹¨ê°€ ëŒ€ë¹„ ì˜¤ëŠ˜ ì¢…ê°€ê°€ ëª©í‘œ ìˆ˜ìµë¥  ì´ìƒì¸ì§€ ì²´í¬
   * - ì²´ê²°ê°€ëŠ” ì˜¤ëŠ˜ ì¢…ê°€(LOC)
   * - ì†ì ˆ: ìµœëŒ€ ë³´ìœ ê¸°ê°„ ë„ë‹¬ ì‹œ
   */
  public getTodaySellSignal(config: {
    ë§¤ë§¤ëª¨ë“œ: 'safe' | 'aggressive';
    ì˜¤ëŠ˜ì¢…ê°€: number;
    í‰ë‹¨ê°€: number;
    ë³´ìœ ëŸ‰: number;
    ë§¤ìˆ˜ì¼ì: string;
    ì˜¤ëŠ˜ë‚ ì§œ: string;
  }): {
    ì‹ í˜¸: 'SELL' | 'STOP_LOSS' | 'HOLD' | 'NO_POSITION';
    ë§¤ë„ëŸ‰: number;
    ë§¤ë„ê°€: number;  // LOC ì²´ê²°ê°€ (ì˜¤ëŠ˜ ì¢…ê°€)
    ë§¤ë„ê¸ˆì•¡: number;
    ìˆ˜ìˆ˜ë£Œ: number;
    ì‹¤í˜„ìˆ˜ìµ: number;
    ìˆ˜ìµë¥ : number;
    ëª©í‘œìˆ˜ìµë¥ : number;
    ê±°ë˜ì¼ë³´ìœ ê¸°ê°„: number;
    ë©”ì‹œì§€: string;
    ì†ì ˆì—¬ë¶€: boolean;
  } {
    const { ë§¤ë§¤ëª¨ë“œ, ì˜¤ëŠ˜ì¢…ê°€, í‰ë‹¨ê°€, ë³´ìœ ëŸ‰, ë§¤ìˆ˜ì¼ì, ì˜¤ëŠ˜ë‚ ì§œ } = config;
    const modeConfig = getModeConfig(ë§¤ë§¤ëª¨ë“œ);

    if (ë³´ìœ ëŸ‰ === 0 || í‰ë‹¨ê°€ === 0) {
      return {
        ì‹ í˜¸: 'NO_POSITION',
        ë§¤ë„ëŸ‰: 0,
        ë§¤ë„ê°€: 0,
        ë§¤ë„ê¸ˆì•¡: 0,
        ìˆ˜ìˆ˜ë£Œ: 0,
        ì‹¤í˜„ìˆ˜ìµ: 0,
        ìˆ˜ìµë¥ : 0,
        ëª©í‘œìˆ˜ìµë¥ : modeConfig.sellTarget * 100,
        ê±°ë˜ì¼ë³´ìœ ê¸°ê°„: 0,
        ë©”ì‹œì§€: 'ë³´ìœ  ì¢…ëª© ì—†ìŒ',
        ì†ì ˆì—¬ë¶€: false
      };
    }

    // ê±°ë˜ì¼ ê¸°ì¤€ ë³´ìœ ê¸°ê°„ ê³„ì‚° (ì£¼ë§ ì œì™¸)
    const ê±°ë˜ì¼ë³´ìœ ê¸°ê°„ = calculateTradingDays(ë§¤ìˆ˜ì¼ì, ì˜¤ëŠ˜ë‚ ì§œ);

    // í‰ë‹¨ê°€ ëŒ€ë¹„ ì˜¤ëŠ˜ ì¢…ê°€ ìˆ˜ìµë¥  ê³„ì‚°
    const ìˆ˜ìµë¥  = (ì˜¤ëŠ˜ì¢…ê°€ - í‰ë‹¨ê°€) / í‰ë‹¨ê°€;
    const ëª©í‘œìˆ˜ìµë¥  = modeConfig.sellTarget;

    // LOC: ì˜¤ëŠ˜ ì¢…ê°€ì— ë§¤ë„
    const ë§¤ë„ê¸ˆì•¡ = ë³´ìœ ëŸ‰ * ì˜¤ëŠ˜ì¢…ê°€;
    const ìˆ˜ìˆ˜ë£Œ = ë§¤ë„ê¸ˆì•¡ * getTotalFeeRate();
    const ë§¤ìˆ˜ì›ê°€ = ë³´ìœ ëŸ‰ * í‰ë‹¨ê°€;
    const ì‹¤í˜„ìˆ˜ìµ = ë§¤ë„ê¸ˆì•¡ - ë§¤ìˆ˜ì›ê°€ - ìˆ˜ìˆ˜ë£Œ;

    // ì¡°ê±´ 1: ìˆ˜ìµ ëª©í‘œ ë‹¬ì„± â†’ LOC ë§¤ë„
    if (ìˆ˜ìµë¥  >= ëª©í‘œìˆ˜ìµë¥ ) {
      return {
        ì‹ í˜¸: 'SELL',
        ë§¤ë„ëŸ‰: ë³´ìœ ëŸ‰,
        ë§¤ë„ê°€: ì˜¤ëŠ˜ì¢…ê°€,  // LOC ì²´ê²°ê°€
        ë§¤ë„ê¸ˆì•¡,
        ìˆ˜ìˆ˜ë£Œ,
        ì‹¤í˜„ìˆ˜ìµ,
        ìˆ˜ìµë¥ : ìˆ˜ìµë¥  * 100,
        ëª©í‘œìˆ˜ìµë¥ : ëª©í‘œìˆ˜ìµë¥  * 100,
        ê±°ë˜ì¼ë³´ìœ ê¸°ê°„,
        ë©”ì‹œì§€: `ğŸ”º LOC ë§¤ë„: ${ë³´ìœ ëŸ‰}ì£¼ @$${ì˜¤ëŠ˜ì¢…ê°€.toFixed(2)} (ìˆ˜ìµë¥  ${(ìˆ˜ìµë¥  * 100).toFixed(2)}% â‰¥ ëª©í‘œ ${(ëª©í‘œìˆ˜ìµë¥  * 100).toFixed(2)}%)`,
        ì†ì ˆì—¬ë¶€: false
      };
    }

    // ì¡°ê±´ 2: ìµœëŒ€ ë³´ìœ ê¸°ê°„ ë„ë‹¬ â†’ LOC ì†ì ˆ
    if (ê±°ë˜ì¼ë³´ìœ ê¸°ê°„ >= modeConfig.holdingDays) {
      return {
        ì‹ í˜¸: 'STOP_LOSS',
        ë§¤ë„ëŸ‰: ë³´ìœ ëŸ‰,
        ë§¤ë„ê°€: ì˜¤ëŠ˜ì¢…ê°€,  // LOC ì²´ê²°ê°€
        ë§¤ë„ê¸ˆì•¡,
        ìˆ˜ìˆ˜ë£Œ,
        ì‹¤í˜„ìˆ˜ìµ,
        ìˆ˜ìµë¥ : ìˆ˜ìµë¥  * 100,
        ëª©í‘œìˆ˜ìµë¥ : ëª©í‘œìˆ˜ìµë¥  * 100,
        ê±°ë˜ì¼ë³´ìœ ê¸°ê°„,
        ë©”ì‹œì§€: `âš ï¸ LOC ì†ì ˆ: ${ë³´ìœ ëŸ‰}ì£¼ @$${ì˜¤ëŠ˜ì¢…ê°€.toFixed(2)} (ë³´ìœ  ${ê±°ë˜ì¼ë³´ìœ ê¸°ê°„}ì¼ â‰¥ ${modeConfig.holdingDays}ì¼)`,
        ì†ì ˆì—¬ë¶€: true
      };
    }

    // ì¡°ê±´ ë¯¸ì¶©ì¡± â†’ ëŒ€ê¸°
    return {
      ì‹ í˜¸: 'HOLD',
      ë§¤ë„ëŸ‰: 0,
      ë§¤ë„ê°€: 0,
      ë§¤ë„ê¸ˆì•¡: 0,
      ìˆ˜ìˆ˜ë£Œ: 0,
      ì‹¤í˜„ìˆ˜ìµ: 0,
      ìˆ˜ìµë¥ : ìˆ˜ìµë¥  * 100,
      ëª©í‘œìˆ˜ìµë¥ : ëª©í‘œìˆ˜ìµë¥  * 100,
      ê±°ë˜ì¼ë³´ìœ ê¸°ê°„,
      ë©”ì‹œì§€: `ëŒ€ê¸°: ìˆ˜ìµë¥  ${(ìˆ˜ìµë¥  * 100).toFixed(2)}% < ëª©í‘œ ${(ëª©í‘œìˆ˜ìµë¥  * 100).toFixed(2)}% (ë³´ìœ  ${ê±°ë˜ì¼ë³´ìœ ê¸°ê°„}/${modeConfig.holdingDays}ì¼)`,
      ì†ì ˆì—¬ë¶€: false
    };
  }

  /**
   * ì¼ë³„ ë§¤ë§¤ ê¸°ë¡ ìƒì„± (ì¢…ê°€ë§¤ë§¤ LOC ë°©ì‹)
   * - ë§¤ìˆ˜/ë§¤ë„ ì²´ê²°ê°€ëŠ” í•­ìƒ ì˜¤ëŠ˜ ì¢…ê°€
   */
  public generateDailyTradeRecord(config: {
    ê±°ë˜ì¼ì: string;
    ì¢…ê°€: number;
    ì „ì¼ì¢…ê°€: number;
    ë§¤ë§¤ëª¨ë“œ: 'safe' | 'aggressive';
    ì´ì „ê¸°ë¡?: DongpaTrade | null;
    ì´ˆê¸°ìê¸ˆ: number;
    ë¶„í• íšŸìˆ˜: number;
    ê°±ì‹ ì£¼ê¸°: number; // ê¸°ë³¸ 10ì¼
  }): DongpaTrade {
    const {
      ê±°ë˜ì¼ì, ì¢…ê°€, ì „ì¼ì¢…ê°€, ë§¤ë§¤ëª¨ë“œ, ì´ì „ê¸°ë¡,
      ì´ˆê¸°ìê¸ˆ, ë¶„í• íšŸìˆ˜, ê°±ì‹ ì£¼ê¸° = 10
    } = config;

    const modeConfig = getModeConfig(ë§¤ë§¤ëª¨ë“œ);

    // ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  ê³„ì‚°
    const ë³€ë™ë¥  = ((ì¢…ê°€ - ì „ì¼ì¢…ê°€) / ì „ì¼ì¢…ê°€) * 100;

    // ìê¸ˆ ê°±ì‹  ì²´í¬ (ê°±ì‹ ì£¼ê¸°ì¼ë§ˆë‹¤)
    const ê±°ë˜ì¼ìˆ˜ = ì´ì „ê¸°ë¡ ? calculateTradingDays(ì´ì „ê¸°ë¡.ê±°ë˜ì¼ì, ê±°ë˜ì¼ì) : 0;
    const ìê¸ˆê°±ì‹  = ê±°ë˜ì¼ìˆ˜ > 0 && ê±°ë˜ì¼ìˆ˜ % ê°±ì‹ ì£¼ê¸° === 0;

    // í˜„ì¬ ì‹œë“œ ê³„ì‚°
    let í˜„ì¬ì‹œë“œ = ì´ˆê¸°ìê¸ˆ;
    if (ì´ì „ê¸°ë¡) {
      í˜„ì¬ì‹œë“œ = ìê¸ˆê°±ì‹  ? ì´ˆê¸°ìê¸ˆ + ì´ì „ê¸°ë¡.ëˆ„ì ì†ìµ : ì´ì „ê¸°ë¡.ì‹œë“œ;
    }

    const ë§¤ìˆ˜ì˜ˆì • = í˜„ì¬ì‹œë“œ / ë¶„í• íšŸìˆ˜;

    // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœ
    const í˜„ì¬ì˜ˆìˆ˜ê¸ˆ = ì´ì „ê¸°ë¡?.ì˜ˆìˆ˜ê¸ˆ || ì´ˆê¸°ìê¸ˆ;
    const í˜„ì¬ë³´ìœ ëŸ‰ = ì´ì „ê¸°ë¡?.ë³´ìœ ëŸ‰ || 0;
    const í˜„ì¬í‰ë‹¨ê°€ = ì´ì „ê¸°ë¡?.í‰ë‹¨ê°€ || 0;
    const ë§¤ìˆ˜ì¼ì = ì´ì „ê¸°ë¡?.ë§¤ìˆ˜ì¼ì || '';

    // ë§¤ìˆ˜ ë¶„ê°€ = ì „ì¼ ì¢…ê°€ Ã— (1 + ëª©í‘œìƒìŠ¹ë¥ ) - í‘œì‹œìš©
    const ë§¤ìˆ˜ì§€ì •ê°€ = ì „ì¼ì¢…ê°€ * (1 + modeConfig.buyTarget);
    const ëª©í‘œëŸ‰ = Math.floor(ë§¤ìˆ˜ì˜ˆì • / ë§¤ìˆ˜ì§€ì •ê°€);

    // ë§¤ìˆ˜ ì‹ í˜¸ ì²´í¬ (ì¢…ê°€ë§¤ë§¤ LOC)
    const ë§¤ìˆ˜ì‹ í˜¸ = this.getTodayBuySignal({
      ì´ˆê¸°ìê¸ˆ: í˜„ì¬ì‹œë“œ,
      ë¶„í• íšŸìˆ˜,
      ë§¤ë§¤ëª¨ë“œ,
      ì˜¤ëŠ˜ì¢…ê°€: ì¢…ê°€,
      ì „ì¼ì¢…ê°€,
      ì˜ˆìˆ˜ê¸ˆ: í˜„ì¬ì˜ˆìˆ˜ê¸ˆ
    });

    // ë§¤ë„ ì‹ í˜¸ ì²´í¬ (ì¢…ê°€ë§¤ë§¤ LOC + ì†ì ˆ)
    const ë§¤ë„ì‹ í˜¸ = this.getTodaySellSignal({
      ë§¤ë§¤ëª¨ë“œ,
      ì˜¤ëŠ˜ì¢…ê°€: ì¢…ê°€,
      í‰ë‹¨ê°€: í˜„ì¬í‰ë‹¨ê°€,
      ë³´ìœ ëŸ‰: í˜„ì¬ë³´ìœ ëŸ‰,
      ë§¤ìˆ˜ì¼ì: ë§¤ìˆ˜ì¼ì,
      ì˜¤ëŠ˜ë‚ ì§œ: ê±°ë˜ì¼ì
    });

    // ê±°ë˜ ì‹¤í–‰
    let ë§¤ìˆ˜ê°€ = 0, ë§¤ìˆ˜ëŸ‰ = 0, ë§¤ìˆ˜ê¸ˆì•¡ = 0, ë§¤ìˆ˜ìˆ˜ìˆ˜ë£Œ = 0;
    let ìƒˆë§¤ìˆ˜ì¼ì = ë§¤ìˆ˜ì¼ì;
    let ë§¤ë„ì¼ = '', ë§¤ë„ê°€ = 0, ë§¤ë„ëŸ‰ = 0, ë§¤ë„ê¸ˆì•¡ = 0, ë§¤ë„ìˆ˜ìˆ˜ë£Œ = 0;
    let ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡ = 0, ì†ìµë¥  = 0, ì†ì ˆì—¬ë¶€ = false;

    // ë§¤ìˆ˜ ì‹¤í–‰ (LOC: ì˜¤ëŠ˜ ì¢…ê°€ì— ì²´ê²°)
    if (ë§¤ìˆ˜ì‹ í˜¸.ì‹ í˜¸ === 'BUY' && í˜„ì¬ë³´ìœ ëŸ‰ === 0) {
      ë§¤ìˆ˜ê°€ = ë§¤ìˆ˜ì‹ í˜¸.ë§¤ìˆ˜ê°€;  // LOC ì²´ê²°ê°€ (ì˜¤ëŠ˜ ì¢…ê°€)
      ë§¤ìˆ˜ëŸ‰ = ë§¤ìˆ˜ì‹ í˜¸.ë§¤ìˆ˜ëŸ‰;
      ë§¤ìˆ˜ê¸ˆì•¡ = ë§¤ìˆ˜ì‹ í˜¸.ë§¤ìˆ˜ê¸ˆì•¡;
      ë§¤ìˆ˜ìˆ˜ìˆ˜ë£Œ = ë§¤ìˆ˜ì‹ í˜¸.ìˆ˜ìˆ˜ë£Œ;
      ìƒˆë§¤ìˆ˜ì¼ì = ê±°ë˜ì¼ì; // ë§¤ìˆ˜ì¼ ê¸°ë¡
    }

    // ë§¤ë„ ì‹¤í–‰ (LOC: ì˜¤ëŠ˜ ì¢…ê°€ì— ì²´ê²°)
    if (ë§¤ë„ì‹ í˜¸.ì‹ í˜¸ === 'SELL' || ë§¤ë„ì‹ í˜¸.ì‹ í˜¸ === 'STOP_LOSS') {
      ë§¤ë„ì¼ = ê±°ë˜ì¼ì;
      ë§¤ë„ê°€ = ë§¤ë„ì‹ í˜¸.ë§¤ë„ê°€;  // LOC ì²´ê²°ê°€ (ì˜¤ëŠ˜ ì¢…ê°€)
      ë§¤ë„ëŸ‰ = ë§¤ë„ì‹ í˜¸.ë§¤ë„ëŸ‰;
      ë§¤ë„ê¸ˆì•¡ = ë§¤ë„ì‹ í˜¸.ë§¤ë„ê¸ˆì•¡;
      ë§¤ë„ìˆ˜ìˆ˜ë£Œ = ë§¤ë„ì‹ í˜¸.ìˆ˜ìˆ˜ë£Œ;
      ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡ = ë§¤ë„ì‹ í˜¸.ì‹¤í˜„ìˆ˜ìµ;
      ì†ìµë¥  = ë§¤ë„ì‹ í˜¸.ìˆ˜ìµë¥ ;
      ì†ì ˆì—¬ë¶€ = ë§¤ë„ì‹ í˜¸.ì†ì ˆì—¬ë¶€;
      ìƒˆë§¤ìˆ˜ì¼ì = ''; // ë§¤ë„ í›„ ë§¤ìˆ˜ì¼ ì´ˆê¸°í™”
    }

    // ë³µë¦¬ ê³„ì‚°
    let ê°±ì‹ ë³µë¦¬ê¸ˆì•¡ = 0;
    if (ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡ !== 0) {
      ê°±ì‹ ë³µë¦¬ê¸ˆì•¡ = ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡ > 0 ?
        ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡ * modeConfig.profitReinvest :  // ì´ìµë³µë¦¬
        ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡ * modeConfig.lossReinvest;     // ì†ì‹¤ë³µë¦¬
    }

    const ëˆ„ì ì†ìµ = (ì´ì „ê¸°ë¡?.ëˆ„ì ì†ìµ || 0) + ê°±ì‹ ë³µë¦¬ê¸ˆì•¡;

    // í¬íŠ¸í´ë¦¬ì˜¤ ì—…ë°ì´íŠ¸
    const ìƒˆì˜ˆìˆ˜ê¸ˆ = í˜„ì¬ì˜ˆìˆ˜ê¸ˆ - ë§¤ìˆ˜ê¸ˆì•¡ - ë§¤ìˆ˜ìˆ˜ìˆ˜ë£Œ + ë§¤ë„ê¸ˆì•¡ - ë§¤ë„ìˆ˜ìˆ˜ë£Œ;
    const ìƒˆë³´ìœ ëŸ‰ = í˜„ì¬ë³´ìœ ëŸ‰ + ë§¤ìˆ˜ëŸ‰ - ë§¤ë„ëŸ‰;

    // í‰ë‹¨ê°€ ì¬ê³„ì‚°
    let ìƒˆí‰ë‹¨ê°€ = 0;
    if (ë§¤ìˆ˜ëŸ‰ > 0 && ìƒˆë³´ìœ ëŸ‰ > 0) {
      const ê¸°ì¡´ë³´ìœ ê°€ì¹˜ = í˜„ì¬ë³´ìœ ëŸ‰ * í˜„ì¬í‰ë‹¨ê°€;
      const ì‹ ê·œë§¤ìˆ˜ê°€ì¹˜ = ë§¤ìˆ˜ëŸ‰ * ë§¤ìˆ˜ê°€;
      ìƒˆí‰ë‹¨ê°€ = (ê¸°ì¡´ë³´ìœ ê°€ì¹˜ + ì‹ ê·œë§¤ìˆ˜ê°€ì¹˜) / ìƒˆë³´ìœ ëŸ‰;
    } else if (ìƒˆë³´ìœ ëŸ‰ > 0) {
      ìƒˆí‰ë‹¨ê°€ = í˜„ì¬í‰ë‹¨ê°€;
    }

    // ëª©í‘œê°€ = í‰ë‹¨ê°€ Ã— (1 + ëª©í‘œìˆ˜ìµë¥ )
    const ëª©í‘œê°€ = ìƒˆí‰ë‹¨ê°€ > 0 ? ìƒˆí‰ë‹¨ê°€ * (1 + modeConfig.sellTarget) : 0;

    // ê±°ë˜ì¼ ë³´ìœ ê¸°ê°„ ê³„ì‚°
    const ê±°ë˜ì¼ë³´ìœ ê¸°ê°„ = ìƒˆë§¤ìˆ˜ì¼ì ? calculateTradingDays(ìƒˆë§¤ìˆ˜ì¼ì, ê±°ë˜ì¼ì) : 0;

    const í‰ê°€ê¸ˆ = ìƒˆë³´ìœ ëŸ‰ * ì¢…ê°€;
    const ì´ìì‚° = ìƒˆì˜ˆìˆ˜ê¸ˆ + í‰ê°€ê¸ˆ;
    const ìˆ˜ìµë¥  = ((ì´ìì‚° - ì´ˆê¸°ìê¸ˆ) / ì´ˆê¸°ìê¸ˆ) * 100;

    // DD ê³„ì‚°
    const ìµœê³ ìì‚° = Math.max(ì´ìì‚°, ì´ì „ê¸°ë¡?.ìµœê³ ìì‚° || ì´ˆê¸°ìê¸ˆ);
    const DD = ìµœê³ ìì‚° > ì´ìì‚° ? ((ìµœê³ ìì‚° - ì´ìì‚°) / ìµœê³ ìì‚°) * 100 : 0;

    const ê±°ë˜ê¸°ë¡: DongpaTrade = {
      ê±°ë˜ì¼ì,
      ì¢…ê°€,
      ë§¤ë§¤ëª¨ë“œ,
      ë³€ë™ë¥ ,
      ë§¤ìˆ˜ì˜ˆì •,
      ë§¤ìˆ˜ì§€ì •ê°€,  // ì „ì¼ ì¢…ê°€ Ã— (1 + ëª©í‘œìƒìŠ¹ë¥ )
      ëª©í‘œëŸ‰,
      ë§¤ìˆ˜ê°€,
      ë§¤ìˆ˜ëŸ‰,
      ë§¤ìˆ˜ê¸ˆì•¡,
      ë§¤ìˆ˜ìˆ˜ìˆ˜ë£Œ,
      ë§¤ë„ì§€ì •ê°€: ëª©í‘œê°€,  // ëª©í‘œ ë§¤ë„ê°€
      ëª©í‘œê°€,
      ë§¤ìˆ˜ì¼ì: ìƒˆë§¤ìˆ˜ì¼ì,
      ê±°ë˜ì¼ë³´ìœ ê¸°ê°„,
      MOC: ë§¤ë„ì‹ í˜¸.ì‹ í˜¸ === 'STOP_LOSS' ? 'STOP_LOSS' :
           ë§¤ë„ì‹ í˜¸.ì‹ í˜¸ === 'SELL' ? 'SELL' : 'HOLD',
      ë§¤ë„ì¼,
      ë§¤ë„ê°€,
      ë§¤ë„ëŸ‰,
      ë§¤ë„ê¸ˆì•¡,
      ë§¤ë„ìˆ˜ìˆ˜ë£Œ,
      ë‹¹ì¼ì‹¤í˜„ì†ìµê¸ˆì•¡,
      ì†ìµë¥ ,
      ì†ì ˆì—¬ë¶€,
      ëˆ„ì ì†ìµ,
      ê°±ì‹ ë³µë¦¬ê¸ˆì•¡,
      ìê¸ˆê°±ì‹ ,
      ì‹œë“œ: í˜„ì¬ì‹œë“œ,
      ì¦ì•¡ì…ì¶œê¸ˆ: 0,
      ì˜ˆìˆ˜ê¸ˆ: ìƒˆì˜ˆìˆ˜ê¸ˆ,
      ë³´ìœ ëŸ‰: ìƒˆë³´ìœ ëŸ‰,
      í‰ê°€ê¸ˆ,
      ì´ìì‚°,
      ìˆ˜ìµë¥ ,
      DD,
      í‰ë‹¨ê°€: ìƒˆí‰ë‹¨ê°€,
      ìµœê³ ìì‚°
    };

    return ê±°ë˜ê¸°ë¡;
  }

  /**
   * ì—¬ëŸ¬ ì¼ìì˜ ë§¤ë§¤ ê¸°ë¡ ìƒì„± (ì¢…ê°€ë§¤ë§¤ LOC + RSI ìë™ ëª¨ë“œ)
   */
  public generateTradeHistory(historicalData: MarketData[]): DongpaTrade[] {
    if (!historicalData.length) return [];

    // RSI ìë™ ëª¨ë“œì¼ ê²½ìš°, ì£¼ê°„ RSI ê¸°ë°˜ ëª¨ë“œ ì •ë³´ ì¶”ê°€
    const enrichedData = this.autoMode
      ? enrichDataWithWeeklyRSIMode(historicalData)
      : historicalData.map(d => ({ ...d, mode: this.config.mode, modeReason: 'ìˆ˜ë™ ì„¤ì •' }));

    const trades: DongpaTrade[] = [];
    let ì´ì „ê¸°ë¡: DongpaTrade | null = null;

    enrichedData.forEach((dayData, index) => {
      // ì „ì¼ ì¢…ê°€ ê°€ì ¸ì˜¤ê¸°
      const ì „ì¼ì¢…ê°€ = index > 0 ? enrichedData[index - 1].price : dayData.price;

      // ìë™ ëª¨ë“œì¼ ê²½ìš°, ì£¼ê°„ RSI ê¸°ë°˜ ëª¨ë“œ ì ìš©
      const ë§¤ë§¤ëª¨ë“œ = this.autoMode
        ? (dayData as { mode: 'safe' | 'aggressive' }).mode
        : this.config.mode;

      const ê±°ë˜ê¸°ë¡ = this.generateDailyTradeRecord({
        ê±°ë˜ì¼ì: dayData.date,
        ì¢…ê°€: dayData.price,
        ì „ì¼ì¢…ê°€,
        ë§¤ë§¤ëª¨ë“œ,
        ì´ì „ê¸°ë¡,
        ì´ˆê¸°ìê¸ˆ: this.config.initialCapital,
        ë¶„í• íšŸìˆ˜: this.config.divisions,
        ê°±ì‹ ì£¼ê¸°: 10
      });

      trades.push(ê±°ë˜ê¸°ë¡);
      ì´ì „ê¸°ë¡ = ê±°ë˜ê¸°ë¡;
    });

    return trades;
  }

  // ì˜¤ëŠ˜ ë§¤ë§¤ ì‹ í˜¸ (ì‹¤ì‹œê°„)
  public getTodayTradingSignals(
    ì˜¤ëŠ˜ì¢…ê°€: number,
    ì „ì¼ì¢…ê°€: number,
    ì˜¤ëŠ˜ë‚ ì§œ: string,
    ìµœê·¼ê±°ë˜ê¸°ë¡?: DongpaTrade
  ): TodaySignal {
    const í˜„ì¬ì˜ˆìˆ˜ê¸ˆ = ìµœê·¼ê±°ë˜ê¸°ë¡?.ì˜ˆìˆ˜ê¸ˆ || this.config.initialCapital;
    const í˜„ì¬ë³´ìœ ëŸ‰ = ìµœê·¼ê±°ë˜ê¸°ë¡?.ë³´ìœ ëŸ‰ || 0;
    const í˜„ì¬í‰ë‹¨ê°€ = ìµœê·¼ê±°ë˜ê¸°ë¡?.í‰ë‹¨ê°€ || 0;
    const í˜„ì¬ì‹œë“œ = ìµœê·¼ê±°ë˜ê¸°ë¡?.ì‹œë“œ || this.config.initialCapital;
    const ë§¤ìˆ˜ì¼ì = ìµœê·¼ê±°ë˜ê¸°ë¡?.ë§¤ìˆ˜ì¼ì || '';

    const ë§¤ìˆ˜ì‹ í˜¸ = this.getTodayBuySignal({
      ì´ˆê¸°ìê¸ˆ: í˜„ì¬ì‹œë“œ,
      ë¶„í• íšŸìˆ˜: this.config.divisions,
      ë§¤ë§¤ëª¨ë“œ: this.config.mode,
      ì˜¤ëŠ˜ì¢…ê°€,
      ì „ì¼ì¢…ê°€,
      ì˜ˆìˆ˜ê¸ˆ: í˜„ì¬ì˜ˆìˆ˜ê¸ˆ
    });

    const ë§¤ë„ì‹ í˜¸ = this.getTodaySellSignal({
      ë§¤ë§¤ëª¨ë“œ: this.config.mode,
      ì˜¤ëŠ˜ì¢…ê°€,
      í‰ë‹¨ê°€: í˜„ì¬í‰ë‹¨ê°€,
      ë³´ìœ ëŸ‰: í˜„ì¬ë³´ìœ ëŸ‰,
      ë§¤ìˆ˜ì¼ì,
      ì˜¤ëŠ˜ë‚ ì§œ
    });

    return { ë§¤ìˆ˜ì‹ í˜¸, ë§¤ë„ì‹ í˜¸ };
  }

  // ì „ëµ ì •ë³´ ë°˜í™˜
  public getStrategyInfo() {
    const modeConfig = getModeConfig(this.config.mode);

    const descriptions = {
      safe: {
        name: "ì•ˆì „ëª¨ë“œ",
        description: "ë³´ìˆ˜ì ì¸ ë§¤ë§¤ë¡œ ì•ˆì •ì ì¸ ìˆ˜ìµ ì¶”êµ¬",
        buyCondition: `ë§¤ìˆ˜ ì¡°ê±´: ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  < ${modeConfig.buyTarget * 100}% (${modeConfig.buyTarget * 100}% ë¯¸ë§Œ ìƒìŠ¹ or í•˜ë½)`,
        sellCondition: `ë§¤ë„ ì¡°ê±´: í‰ë‹¨ê°€ ëŒ€ë¹„ ${modeConfig.sellTarget * 100}% ìˆ˜ìµ ë˜ëŠ” ${modeConfig.holdingDays}ê±°ë˜ì¼ ë„ë‹¬ ì‹œ ì†ì ˆ`,
        riskLevel: "ì¤‘ê°„",
        expectedReturn: "ì—° 15-25%",
        maxDrawdown: "20-30%",
        maxHoldingDays: modeConfig.holdingDays
      },
      aggressive: {
        name: "ê³µì„¸ëª¨ë“œ",
        description: "ì ê·¹ì ì¸ ë§¤ë§¤ë¡œ ë†’ì€ ìˆ˜ìµ ì¶”êµ¬",
        buyCondition: `ë§¤ìˆ˜ ì¡°ê±´: ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  < ${modeConfig.buyTarget * 100}% (${modeConfig.buyTarget * 100}% ë¯¸ë§Œ ìƒìŠ¹ or í•˜ë½)`,
        sellCondition: `ë§¤ë„ ì¡°ê±´: í‰ë‹¨ê°€ ëŒ€ë¹„ ${modeConfig.sellTarget * 100}% ìˆ˜ìµ ë˜ëŠ” ${modeConfig.holdingDays}ê±°ë˜ì¼ ë„ë‹¬ ì‹œ ì†ì ˆ`,
        riskLevel: "ë†’ìŒ",
        expectedReturn: "ì—° 30-50%",
        maxDrawdown: "40-60%",
        maxHoldingDays: modeConfig.holdingDays
      }
    };

    return descriptions[this.config.mode];
  }
}